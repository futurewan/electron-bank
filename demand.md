# 第一部分：产品需求文档 (PRD)

## 1. 项目背景与目标

- **项目名称：** 银企自动核销 Agent (桌面版)
- **核心定位：** 基于 RPA（执行）+ AI（语义判断）的本地化税务合规工具。
- **适用场景：** 财务人员在月结/季结时，对银行流水与发票进行批量比对核销。
- **核心价值：** 解决“金额微差（手续费）”和“人名不符（代付）”的人工核对痛点。

## 2. 系统输入 (Input)

系统需在桌面端提供配置入口，允许用户指定以下三个本地数据源：

1. **银行流水文件夹：** 仅支持 Excel (.xlsx/.csv)。
2. **发票文件夹：** 支持 Excel (.xlsx) 和 电子 PDF（非扫描件）。
3. **系统备注/花名册（关键新增）：** 一个 Excel 文件或本地数据库。
    - *数据结构示例：* `[销售员, 备注内容, 更新时间]`
    - *内容示例：* “王大力, 张三是蚂蚁公司的采购经理，后续汇款由张三代付”

## 3. 核心业务逻辑 (The Core Engine)

系统采用**“漏斗式”**匹配策略，数据依次流经三层滤网：

### 第一层：RPA 硬规则匹配 (Rule-Based Match)

- **执行者：** RPA (Python Pandas 逻辑)
- **规则 A（完美匹配）：**
    - `银行.交易金额` == `发票.价税合计`
    - `银行.对方户名` == `发票.销售方名称`
    - **结果：** 进入《自动入账凭证源》。
- **规则 B（手续费容差匹配）：**
    - `银行.对方户名` == `发票.销售方名称`
    - `0 < (发票.价税合计 - 银行.交易金额) <= 20元`
    - **结果：** 进入《可解释性报告》，标记原因“跨行转账手续费”。

### 第二层：AI 语义匹配 (Agent-Based Match)

- **执行者：** AI Agent (基于本地备注数据的推理)
- **触发条件：** 金额一致（或差额≤20），但**户名不一致**。
- **场景（代付识别）：**
    - **输入给 Agent：**
        - 银行户名：“张三”
        - 发票户名：“蚂蚁公司”
        - 参考信息（来自备注表）：“销售员登记：张三是蚂蚁公司的采购经理”
    - **Agent 思考链 (CoT)：**
        1. 分析备注语义，提取关系：`张三` BELONGS_TO `蚂蚁公司`。
        2. 比对当前冲突：银行是 `张三`，发票是 `蚂蚁公司`。
        3. 结论：逻辑成立。
    - **结果：** 进入《可解释性报告》，标记原因“个人代付公款（AI置信度98%）”。

### 第三层：异常捕获 (Exception Handling)

- **执行者：** RPA
- **触发条件：** 上述两层均未匹配成功的数据。
- **分类：**
    1. **有水无票：** 银行流水剩余未核销项。
    2. **重复支付：** 银行流水有多笔相同金额/户名，但发票数量不足。
    3. **金额不符：** 户名一致，但差额 > 20元。
    - **结果：** 进入《异常情况处理报告》。

## 4. 输出产物 (Output)

生成 3 个 Excel 文件，并按 `类型_日期.xlsx` 命名：

1. **自动入账凭证源.xlsx：** 包含完美匹配的流水号、发票号、金额。
2. **可解释性报告.xlsx：** 包含手续费差异项、AI 判定的代付项（附带 Agent 的推理原话作为证据）。
3. **异常情况处理报告.xlsx：** 包含所有未匹配项及错误类型。

---

# 第二部分：落地流程与技术架构分析

基于你提供的“非侵入式桌面端”方案，以下是**严格的**技术实现流程。

### 1. 架构设计：大脑与手脚的真实关系

- **前端（壳）：** Electron 或 PyQt。提供“选择文件夹”和“开始核销”按钮，以及最后的图表展示。
- **后端（RPA引擎）：** Python (Pandas + PDFPlumber)。**注意：这里的 RPA 不是模拟鼠标点击，而是后台数据处理。**
- **大脑（AI Agent）：** 调用 LLM API（如通义千问/文心一言/DeepSeek），用于处理“备注表”的语义理解。

### 2. 详细执行流程 (Step-by-Step)

### 步骤 1：静默数据加载 (Data Ingestion)

- **用户动作：** 点击“开始核销”。
- **RPA 动作（后台）：**
    - **读取流水：** 直接加载 Excel 到内存 DataFrame。
    - **读取发票：**
        - 如果是 Excel：直接加载。
        - 如果是 **电子 PDF**：调用 `pdfplumber` 或 `PyMuPDF` 库提取文本。**（严禁使用截图OCR，因为电子PDF自带文本层，直接提取准确率100%且速度极快）**。
        - 提取关键字段：`发票代码`、`销售方`、`价税合计`。
    - **读取备注：** 加载 `备注信息.xlsx`。

### 步骤 2：预处理与向量化 (Preprocessing)

- **RPA 动作：**
    - 数据清洗：去除户名中的“有限公司”、“(中国)”等干扰词，统一金额格式。
    - **关键优化：** 将 `备注信息` 发送给 AI，让 AI 提取出结构化关系表：`{ "张三": ["蚂蚁公司", "支付宝公司"], "李四": ["字节跳动"] }`。这一步叫**知识库预构建**。

### 步骤 3：核心匹配循环 (The Loop)

- **阶段 A（极速版）：**
    - 利用 Pandas 进行 `Merge` 操作。
    - 条件：`Name == Name` AND `Amount == Amount`。
    - 命中数据直接打标“Success”。
- **阶段 B（规则版）：**
    - 条件：`Name == Name` AND `abs(Amount - Amount) <= 20`。
    - 命中数据打标“Fee_Diff”。
- **阶段 C（AI 介入版）：**
    - 筛选出 `Amount == Amount` 但 `Name != Name` 的残余数据。
    - 遍历这些数据，查表（步骤2构建的关系表）：
        - *Check:* 银行户名“张三”是否在关系表里关联了发票户名“蚂蚁公司”？
    - 如果查不到，再把原始备注扔给 LLM 做最后一次判断（防止提取遗漏）。
    - 命中数据打标“Proxy_Pay”。

### 步骤 4：报告生成 (Reporting)

- **RPA 动作：**
    - 将打标数据分流，写入 3 个不同的 Excel 模板。
    - 调用 Python 的 `OS` 库重命名文件。
    - 前端界面读取统计数据，渲染饼图。

---

# 第三部分：客观挑刺与风险预警 (Critical Review)

为了保证项目不烂尾，我必须指出这个方案中隐藏的 **3 个落地风险点**：

### 1. “电子 PDF”解析的陷阱

- **风险：** 你提到发票是“电子 PDF”。虽然不是扫描件，但**数电票（OFD/PDF）、老版税控盘导出的 PDF、第三方平台生成的 PDF**，它们的**排版布局（Layout）是完全不同的**。
- **问题：** 简单的文本提取可能会把“备注栏”的数字误读为“金额”，或者找不到“销售方”在哪一行。
- **修正建议：** 必须使用**基于正则表达式的锚点定位**（比如先找关键词“价税合计”，再取其右边的数字），或者专门针对国家税务局的标准版式开发解析模板。不要指望一个脚本能读懂所有格式的 PDF。

### 2. “备注数据”的来源悖论

- **风险：** 你依赖“系统备注里销售员曾登记...”。请问这个“系统”是哪个系统？RPA 能连进去吗？
- **问题：** 如果这个备注散落在 CRM 系统、微信聊天记录或者销售的脑子里，AI 是读不到的。
- **修正建议：** 项目初期，必须强制要求销售或财务维护一个**标准的《特殊付款人对应表.xlsx》**。AI 的能力边界在于**“理解这张表里的自然语言”**，而不是**“凭空知道张三是谁”**。

### 3. 同名同姓与多重关系的干扰

- **风险：** 如果备注里写“王伟代付”。中国有几十万个王伟。
- **问题：** AI 可能会把 A 公司的王伟匹配给 B 公司的发票，导致张冠李戴。
- **修正建议：** 增加**“账号校验”**。代付识别不能只看名字，最好能让 AI 记住：“这个银行卡号（尾号1234）的王伟，是蚂蚁公司的”。**账号是唯一的，名字不是。**