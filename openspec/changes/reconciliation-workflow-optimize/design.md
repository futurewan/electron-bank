# 设计文档：对账流程优化

## 背景

### 当前状态
- 每次新建对账时需要手动点击「导入流水」和「导入发票」按钮选择文件
- 批次状态包括：`pending`、`importing`、`matching`、`completed`、`failed`
- 用户可以在任意状态下标记批次为"已完成"，即使账目未平
- 完成对账后没有自动归档机制，历史数据管理困难
- 代付检测采用规则判断，未设定严格的置信度阈值

### 约束
- 使用 Electron + SQLite 架构
- 配置存储使用 `electron-store`
- 现有 IPC 通道结构需保持兼容

---

## 目标 / 非目标

**目标：**
1. 简化新建对账流程，减少重复操作
2. 增强数据完整性，防止未平账被错误完成
3. 提供完成后的自动归档能力
4. 提高代付检测准确度

**非目标：**
- 不改动现有匹配算法核心逻辑
- 不引入云存储或远程同步
- 不重构整体数据库 schema

---

## 决策

### 决策 1：文件夹配置存储方案

**选择：** 扩展 `AppConfig` 接口，添加三个新配置项

```typescript
interface AppConfig {
  // 现有配置...
  
  // 新增：对账文件夹配置
  bankStatementFolder?: string     // 银行流水文件夹
  invoiceFolder?: string           // 发票文件夹
  archiveFolder?: string           // 归档文件夹
}
```

**理由：**
- 与现有配置体系一致
- 开箱即用的持久化能力
- 无需新增数据库表

**备选方案：**
- 新建数据库表存储 → 过于复杂，配置类数据不需要关系型存储

---

### 决策 2：新建对账流程改造

**选择：** 条件触发式弹窗 + 自动扫描

**流程：**
1. 用户点击「新建对账」
2. 检查 `bankStatementFolder` 和 `invoiceFolder` 是否已配置
3. 若未配置 → 弹出设置弹窗，要求选择文件夹
4. 若已配置 → 自动扫描文件夹内的 xlsx/xls 文件
5. 显示扫描结果确认弹窗（文件列表）
6. 用户确认后自动导入

**UI 变更：**
- 移除「导入流水」和「导入发票」按钮
- 保留「新建对账」按钮，内置自动导入逻辑
- 设置中心新增「对账文件夹」配置页

---

### 决策 3：批次状态增强

**选择：** 新增 `unbalanced` 状态，增加完成前校验

**状态流转：**
```
pending → importing → matching → [unbalanced | completed]
                              ↓
                          (有异常/未平) → unbalanced
                          (全部匹配)   → completed
```

**校验逻辑：**
- 完成前检查 `unmatchedCount > 0` 或 `exceptionCount > 0`
- 若存在未处理项，状态设为 `unbalanced`，禁止直接跳到 `completed`
- 只有账目完全匹配且异常全部处理后，才能标记为 `completed`

**Schema 变更：**
```typescript
status: text('status', { 
  enum: ['pending', 'importing', 'matching', 'unbalanced', 'completed', 'failed'] 
})
```

---

### 决策 4：归档功能实现

**选择：** 完成后手动触发归档按钮

**流程：**
1. 批次状态为 `completed` 时，显示「归档」按钮
2. 点击归档时检查 `archiveFolder` 是否配置
3. 若未配置 → 弹窗要求设置
4. 若已配置 → 执行归档操作

**归档内容：**
- 将批次相关的报告文件移动到归档文件夹
- 在归档文件夹创建按日期组织的子目录：`YYYY-MM-DD_批次名称/`
- 保留数据库记录，可选标记为 `archived` 状态

---

### 决策 5：代付置信度调整

**选择：** 将 `isLikelyPersonName` 规则收紧

**变更点：**
- 在 `mappingService.ts` 中增加更严格的匹配规则
- 只有满足以下全部条件才判定为疑似代付：
  1. 中文字符 2-3 个（原为 2-4）
  2. 不含任何公司关键词
  3. 不含数字或特殊符号
  4. 名字长度 2-3 个字符（原为 2-6）

**效果：** 减少误判概率，提高检测精准度到约 99%

---

## 风险 / 权衡

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 用户忘记设置文件夹 | 无法新建对账 | 首次使用时强制引导，设置中心提供修改入口 |
| 自动扫描文件过多 | 性能问题 | 限制扫描深度（仅顶层），限制文件数量上限 |
| 状态变更破坏现有数据 | 历史批次状态不一致 | 迁移脚本将旧 `completed` 保持不变 |
| 归档文件夹权限问题 | 写入失败 | 错误提示并允许重新选择 |

---

## 迁移计划

1. **数据库迁移**
   - 更新 schema 添加 `unbalanced` 状态
   - 无需迁移现有数据（枚举扩展兼容）

2. **配置迁移**
   - 新增配置项默认为空
   - 首次使用触发配置流程

3. **回滚策略**
   - `unbalanced` 状态在旧版本会显示为未知状态，但不影响核心功能
   - 配置扩展无破坏性

---

## 待解决问题

1. 自动扫描的文件命名规范是否需要固定（如 `bank_*.xlsx`）？
2. 归档时是复制还是移动原始文件？
3. 是否需要支持多个文件夹配置（如不同银行账户）？
