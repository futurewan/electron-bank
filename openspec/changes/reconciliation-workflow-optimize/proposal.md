# 提案：对账流程优化

## 问题

当前对账流程存在以下痛点：

1. **重复操作**：每次新建对账时需要手动点击「导入流水」和「导入发票」按钮选择文件，操作繁琐
2. **数据完整性风险**：用户可以在任意状态下将对账批次标记为"已完成"，即使账目未平也能完成，导致数据不准确
3. **历史数据管理困难**：完成对账后没有自动归档机制，历史数据散落在系统中
4. **代付检测误判**：当前代付检测规则过于宽松，存在误判情况

## 解决方案

本提案旨在通过以下改造优化对账流程：

### 1. 自动化文件导入

- 移除「导入流水」和「导入发票」按钮
- 引入文件夹配置机制，允许用户设置固定的银行流水和发票存放文件夹
- 新建对账时自动扫描配置的文件夹，读取待导入的文件
- 首次使用或未配置时弹窗引导设置
- 在设置中心提供修改入口

### 2. 对账完整性约束

- 如果存在未匹配项或未处理的异常，禁止将批次标记为「已完成」
- 引入新状态 `unbalanced`（未平账），表示账目尚未平衡
- 只有当所有项目匹配完成且异常全部处理后，才能进入「已完成」状态

### 3. 归档功能

- 对账完成后提供「归档」操作
- 配置归档文件夹路径，首次归档时引导设置
- 将报告文件复制到归档文件夹，按日期组织

### 4. 代付检测优化

- 收紧代付检测规则，提高置信度至约 99%
- 减少误判，只有高度疑似个人姓名的付款人才会被标记

## 目标

- 减少新建对账时的手动操作
- 确保数据完整性，防止未平账被错误完成
- 提供结构化的历史数据管理方式
- 提高代付检测的准确度

## 涉及变更

### 新增能力

- `reconciliation-automation`：文件夹配置、自动扫描导入、归档功能

### 修改能力

- `reconciliation-core`：批次状态流转逻辑、完成前校验规则
- `payer-mapping`：代付检测规则调整

## 影响范围

- **界面**：新建对账流程变更、移除手动导入按钮、新增设置页面
- **后端**：新增文件夹管理 IPC 处理器、文件扫描服务、归档服务
- **数据模型**：批次状态枚举扩展、配置存储新增字段
