# 提案：付款人映射智能管理增强

## 背景

当前系统的付款人映射表是全局共享的，但存在以下问题：

1. **发现性差**：用户可能不知道需要导入映射关系
2. **时机割裂**：导入映射和开始对账在不同界面，用户容易遗漏
3. **维护困难**：没有专门页面查看和管理已有的映射关系
4. **无智能提醒**：系统不会主动提示用户可能遗漏了映射

## 目标

优化付款人映射的使用体验，使用户能够：
1. 在对账前得到智能提醒，发现可能需要添加的映射
2. 快速添加新的映射关系
3. 方便地查看和维护现有映射

## 方案概述

### 功能一：智能代付检测与提醒

**触发时机**：用户点击"开始对账"时

**检测逻辑**：
1. 扫描批次内银行流水的付款人名称
2. 识别"疑似个人户名"的记录
   - 名字长度 2-4 个汉字
   - 不含"公司"、"有限"、"集团"、"店"、"厂"等关键词
   - 不在已有发票销售方名单中
3. 检查这些记录是否已有映射关系
4. 如有未映射的疑似代付，弹窗提醒用户

**弹窗内容**：
- 列出所有疑似代付的银行流水
- 显示付款人、金额、备注、检测原因
- 提供三个选项：
  - **添加映射关系**：进入快速添加流程
  - **跳过继续对账**：忽略提醒，继续对账
  - **取消**：返回详情页

### 功能二：快速添加映射关系

**交互方式**：在提醒弹窗中点击"添加映射关系"

**流程**：
1. 展示待添加映射的列表
2. 用户逐条或批量填写对应公司名称
   - 提供下拉建议（从发票销售方名单中匹配）
   - 支持手动输入新公司名称
3. 可选填写账户后四位、备注
4. 保存后返回对账流程

### 功能三：映射关系管理页面

**入口**：侧边栏新增"映射管理"菜单

**页面功能**：
- 查看所有已添加的映射关系（表格展示）
- 支持搜索和筛选（按付款人、公司名称）
- 支持手动添加新映射
- 支持编辑现有映射
- 支持删除映射
- 支持导入/导出 Excel

**表格字段**：
| 付款人 | 对应公司 | 账户后四位 | 来源 | 添加时间 | 操作 |

## 范围

### 包含
- 智能代付检测服务
- 对账前提醒弹窗
- 快速添加映射 UI
- 映射关系管理页面（CRUD）
- 映射数据的导入导出

### 不包含
- 批次级映射（保持全局映射模式）
- AI 自动推荐映射
- 映射规则的版本管理

## 预估工作量

| 模块 | 任务数 | 预估时间 |
|------|--------|----------|
| 智能检测服务 | 2 | 1-2h |
| 提醒弹窗 UI | 2 | 1-2h |
| 快速添加流程 | 2 | 1-2h |
| 映射管理页面 | 3 | 2-3h |
| **总计** | **9** | **5-9h** |

## 决策点

1. ✅ 保持全局映射模式，不做批次级隔离
2. ✅ 智能检测在"开始对账"时触发
3. ✅ 提供弹窗内快速添加，无需跳转页面
4. ✅ 新增独立的映射管理页面

---

**状态**: ✅ 已确认  
**下一步**: 创建设计文档
