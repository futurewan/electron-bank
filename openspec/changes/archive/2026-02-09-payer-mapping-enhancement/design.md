# è®¾è®¡æ–‡æ¡£ï¼šä»˜æ¬¾äººæ˜ å°„æ™ºèƒ½ç®¡ç†å¢å¼º

## 1. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‰ç«¯ (React)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ReconciliationDetail  â”‚  â”‚  MappingReminder   â”‚  â”‚  PayerMappings     â”‚  â”‚
â”‚  â”‚  (å¯¹è´¦è¯¦æƒ…é¡µ)      â”‚  â”‚  (æé†’å¼¹çª—)        â”‚  â”‚  (ç®¡ç†é¡µé¢)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                        â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                        â”‚
            â–¼                     â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         IPC é€šé“ (preload.ts)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  reconciliation:detect-proxy-payments   (æ£€æµ‹ç–‘ä¼¼ä»£ä»˜)                   â”‚
â”‚  reconciliation:add-mapping             (æ·»åŠ å•æ¡æ˜ å°„)                   â”‚
â”‚  reconciliation:batch-add-mappings      (æ‰¹é‡æ·»åŠ æ˜ å°„)                   â”‚
â”‚  reconciliation:get-all-mappings        (è·å–æ‰€æœ‰æ˜ å°„)                   â”‚
â”‚  reconciliation:update-mapping          (æ›´æ–°æ˜ å°„)                       â”‚
â”‚  reconciliation:delete-mapping          (åˆ é™¤æ˜ å°„)                       â”‚
â”‚  reconciliation:export-mappings         (å¯¼å‡ºæ˜ å°„)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»è¿›ç¨‹ (Electron)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    mappingService.ts                             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  detectProxyPayments(batchId)    â†’ ProxyPaymentResult[]         â”‚   â”‚
â”‚  â”‚  addMapping(mapping)             â†’ void                          â”‚   â”‚
â”‚  â”‚  batchAddMappings(mappings)      â†’ { success, failed }          â”‚   â”‚
â”‚  â”‚  getAllMappings()                â†’ PayerMapping[]                â”‚   â”‚
â”‚  â”‚  updateMapping(id, data)         â†’ void                          â”‚   â”‚
â”‚  â”‚  deleteMapping(id)               â†’ void                          â”‚   â”‚
â”‚  â”‚  exportMappings(filePath)        â†’ void                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SQLite æ•°æ®åº“                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  payer_mappings è¡¨ (å·²å­˜åœ¨ï¼Œæ— éœ€ä¿®æ”¹)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ id | person_name | company_name | account_suffix | remark | ... â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ™ºèƒ½ä»£ä»˜æ£€æµ‹

### 2.1 æ£€æµ‹ç®—æ³•

```typescript
interface ProxyPaymentResult {
  bankTransactionId: string
  payerName: string
  amount: number
  remark: string | null
  transactionDate: Date | null
  reason: string  // æ£€æµ‹åŸå› 
}

async function detectProxyPayments(batchId: string): Promise<ProxyPaymentResult[]> {
  // 1. è·å–æ‰¹æ¬¡å†…æ‰€æœ‰é“¶è¡Œæµæ°´
  const bankTxs = await getBankTransactions(batchId)
  
  // 2. è·å–ç°æœ‰æ˜ å°„è¡¨
  const existingMappings = await getAllMappings()
  const mappedNames = new Set(existingMappings.map(m => m.personName))
  
  // 3. è·å–å‘ç¥¨é”€å”®æ–¹åå•
  const invoices = await getInvoices(batchId)
  const companyNames = new Set(invoices.map(i => i.sellerName))
  
  // 4. æ£€æµ‹æ¯æ¡é“¶è¡Œæµæ°´
  const results: ProxyPaymentResult[] = []
  
  for (const tx of bankTxs) {
    const payerName = tx.payerName
    
    // å·²æœ‰æ˜ å°„ï¼Œè·³è¿‡
    if (mappedNames.has(payerName)) continue
    
    // æ˜¯å…¬å¸åï¼Œè·³è¿‡
    if (companyNames.has(payerName)) continue
    
    // åˆ¤æ–­æ˜¯å¦ç–‘ä¼¼ä¸ªäººæˆ·å
    if (isLikelyPersonName(payerName)) {
      results.push({
        bankTransactionId: tx.id,
        payerName,
        amount: tx.amount,
        remark: tx.remark,
        transactionDate: tx.transactionDate,
        reason: 'ç–‘ä¼¼ä¸ªäººæˆ·å'
      })
    }
  }
  
  return results
}

function isLikelyPersonName(name: string): boolean {
  // è§„åˆ™ 1: é•¿åº¦ 2-4 ä¸ªæ±‰å­—
  const chineseChars = name.match(/[\u4e00-\u9fa5]/g)
  if (!chineseChars || chineseChars.length < 2 || chineseChars.length > 4) {
    return false
  }
  
  // è§„åˆ™ 2: ä¸å«å…¬å¸å…³é”®è¯
  const companyKeywords = ['å…¬å¸', 'æœ‰é™', 'é›†å›¢', 'å•†åº—', 'åº—', 'å‚', 'ä¼ä¸š', 'äº‹åŠ¡æ‰€']
  if (companyKeywords.some(kw => name.includes(kw))) {
    return false
  }
  
  // è§„åˆ™ 3: ä¸æ˜¯çº¯æ•°å­—æˆ–å­—æ¯
  if (/^[\d\w]+$/.test(name)) {
    return false
  }
  
  return true
}
```

### 2.2 å»é‡é€»è¾‘

åŒä¸€ä»˜æ¬¾äººå¯èƒ½æœ‰å¤šç¬”äº¤æ˜“ï¼Œæ£€æµ‹ç»“æœéœ€èšåˆï¼š

```typescript
interface AggregatedProxyPayment {
  payerName: string
  totalAmount: number
  transactionCount: number
  transactions: ProxyPaymentResult[]
  reason: string
}

function aggregateByPayer(results: ProxyPaymentResult[]): AggregatedProxyPayment[] {
  const grouped = new Map<string, ProxyPaymentResult[]>()
  
  for (const r of results) {
    const list = grouped.get(r.payerName) || []
    list.push(r)
    grouped.set(r.payerName, list)
  }
  
  return Array.from(grouped.entries()).map(([payerName, txs]) => ({
    payerName,
    totalAmount: txs.reduce((sum, t) => sum + t.amount, 0),
    transactionCount: txs.length,
    transactions: txs,
    reason: txs[0].reason
  }))
}
```

---

## 3. æé†’å¼¹çª— UI

### 3.1 ç»„ä»¶ç»“æ„

```
src/components/MappingReminderModal/
â”œâ”€â”€ index.tsx           # ä¸»å¼¹çª—ç»„ä»¶
â”œâ”€â”€ ProxyPaymentTable.tsx  # ç–‘ä¼¼ä»£ä»˜åˆ—è¡¨è¡¨æ ¼
â”œâ”€â”€ QuickAddForm.tsx    # å¿«é€Ÿæ·»åŠ è¡¨å•
â””â”€â”€ index.module.css    # æ ·å¼
```

### 3.2 å¼¹çª—çŠ¶æ€æœº

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   closed    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ æ£€æµ‹åˆ°ç–‘ä¼¼ä»£ä»˜
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   preview   â”‚  â† å±•ç¤ºç–‘ä¼¼ä»£ä»˜åˆ—è¡¨
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   adding   â”‚  â”‚   skip     â”‚  â”‚   cancel   â”‚
    â”‚ (æ·»åŠ æ˜ å°„)  â”‚  â”‚ (è·³è¿‡ç»§ç»­) â”‚  â”‚  (å–æ¶ˆ)    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚               â”‚
          â–¼               â–¼               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
    â”‚  complete  â”‚  â”‚ ç»§ç»­å¯¹è´¦   â”‚       â”‚
    â”‚ (æ·»åŠ å®Œæˆ) â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
          â”‚                              â”‚
          â–¼                              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
    â”‚ ç»§ç»­å¯¹è´¦   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Props å®šä¹‰

```typescript
interface MappingReminderModalProps {
  open: boolean
  batchId: string
  proxyPayments: AggregatedProxyPayment[]
  onAddMappings: (mappings: NewMapping[]) => Promise<void>
  onSkip: () => void
  onCancel: () => void
}
```

---

## 4. æ˜ å°„ç®¡ç†é¡µé¢

### 4.1 é¡µé¢ç»“æ„

```
src/pages/PayerMappings/
â”œâ”€â”€ index.tsx           # ä¸»é¡µé¢
â”œâ”€â”€ MappingTable.tsx    # æ˜ å°„åˆ—è¡¨è¡¨æ ¼
â”œâ”€â”€ AddMappingModal.tsx # æ·»åŠ /ç¼–è¾‘å¼¹çª—
â””â”€â”€ index.module.css    # æ ·å¼
```

### 4.2 é¡µé¢åŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»˜æ¬¾äººæ˜ å°„ç®¡ç†                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ” æœç´¢: [           ]   æ¥æº: [å…¨éƒ¨ â–¼]   [+ æ·»åŠ ] [â†“ å¯¼å‡º]    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä»˜æ¬¾äºº   â”‚ å¯¹åº”å…¬å¸         â”‚ è´¦æˆ·åå››ä½ â”‚ æ¥æº   â”‚ æ·»åŠ æ—¶é—´    â”‚ æ“ä½œâ”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚  â”‚ å¼ ä¸‰     â”‚ ABCæœ‰é™å…¬å¸      â”‚ 1234       â”‚ æ‰‹åŠ¨   â”‚ 2026-02-09  â”‚ âœï¸ğŸ—‘â”‚
â”‚  â”‚ æå››     â”‚ XYZç§‘æŠ€æœ‰é™å…¬å¸  â”‚            â”‚ å¯¼å…¥   â”‚ 2026-02-08  â”‚ âœï¸ğŸ—‘â”‚
â”‚  â”‚ ...      â”‚ ...              â”‚ ...        â”‚ ...    â”‚ ...         â”‚ ...â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  å…± 23 æ¡è®°å½•                                               é¡µç : 1/3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 è·¯ç”±é…ç½®

```typescript
// src/router/index.tsx
<Route path="/payer-mappings" element={<PayerMappings />} />
```

### 4.4 ä¾§è¾¹æ å…¥å£

åœ¨ Layout/Sidebar ä¸­æ·»åŠ èœå•é¡¹ï¼š
```typescript
{
  key: '/payer-mappings',
  icon: <Users size={20} />,
  label: 'æ˜ å°„ç®¡ç†',
}
```

---

## 5. IPC æ¥å£è®¾è®¡

### 5.1 é€šé“å®šä¹‰

```typescript
// electron/ipc/channels.ts
export const RECONCILIATION_CHANNELS = {
  // ... ç°æœ‰é€šé“
  
  // æ˜ å°„ç®¡ç†
  DETECT_PROXY_PAYMENTS: 'reconciliation:detect-proxy-payments',
  ADD_MAPPING: 'reconciliation:add-mapping',
  BATCH_ADD_MAPPINGS: 'reconciliation:batch-add-mappings',
  GET_ALL_MAPPINGS: 'reconciliation:get-all-mappings',
  UPDATE_MAPPING: 'reconciliation:update-mapping',
  DELETE_MAPPING: 'reconciliation:delete-mapping',
  EXPORT_MAPPINGS: 'reconciliation:export-mappings',
}
```

### 5.2 å¤„ç†å™¨å®ç°

```typescript
// electron/ipc/handlers/reconciliation.ts

// æ£€æµ‹ç–‘ä¼¼ä»£ä»˜
ipcMain.handle(RECONCILIATION_CHANNELS.DETECT_PROXY_PAYMENTS, 
  async (_, { batchId }) => {
    try {
      const results = await detectProxyPayments(batchId)
      const aggregated = aggregateByPayer(results)
      return { success: true, proxyPayments: aggregated }
    } catch (error) {
      return { success: false, error: error.message }
    }
  }
)

// è·å–æ‰€æœ‰æ˜ å°„
ipcMain.handle(RECONCILIATION_CHANNELS.GET_ALL_MAPPINGS, async () => {
  try {
    const mappings = await getAllPayerMappings()
    return { success: true, mappings }
  } catch (error) {
    return { success: false, error: error.message }
  }
})

// ... å…¶ä»–å¤„ç†å™¨
```

---

## 6. æ•°æ®åº“

### 6.1 ç°æœ‰è¡¨ç»“æ„ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

```sql
CREATE TABLE payer_mappings (
  id TEXT PRIMARY KEY,
  person_name TEXT NOT NULL,
  company_name TEXT NOT NULL,
  account_suffix TEXT,
  remark TEXT,
  source TEXT DEFAULT 'manual',  -- 'manual' | 'import' | 'quick_add'
  created_at INTEGER NOT NULL
);
```

### 6.2 æ–°å¢ source å€¼

- `manual`: æ‰‹åŠ¨æ·»åŠ 
- `import`: Excel å¯¼å…¥
- `quick_add`: å¯¹è´¦æ—¶å¿«é€Ÿæ·»åŠ 

---

## 7. å¯¹è´¦æµç¨‹é›†æˆ

### 7.1 ä¿®æ”¹å¯¹è´¦è¯¦æƒ…é¡µ

```typescript
// src/pages/ReconciliationDetail/index.tsx

const handleStartReconciliation = async () => {
  // Step 1: æ£€æµ‹ç–‘ä¼¼ä»£ä»˜
  const detectResult = await electron.reconciliation.detectProxyPayments(batchId)
  
  if (detectResult.success && detectResult.proxyPayments?.length > 0) {
    // æœ‰ç–‘ä¼¼ä»£ä»˜ï¼Œæ˜¾ç¤ºæé†’å¼¹çª—
    setProxyPayments(detectResult.proxyPayments)
    setReminderModalVisible(true)
    return  // ç­‰å¾…ç”¨æˆ·æ“ä½œ
  }
  
  // æ— ç–‘ä¼¼ä»£ä»˜ï¼Œç›´æ¥å¼€å§‹å¯¹è´¦
  executeReconciliation()
}

const handleSkipReminder = () => {
  setReminderModalVisible(false)
  executeReconciliation()  // ç»§ç»­å¯¹è´¦
}

const handleAddMappings = async (mappings: NewMapping[]) => {
  await electron.reconciliation.batchAddMappings(mappings)
  setReminderModalVisible(false)
  executeReconciliation()  // æ·»åŠ åç»§ç»­å¯¹è´¦
}
```

---

## 8. å…³é”®å†³ç­–

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|------|------|------|
| æ£€æµ‹æ—¶æœº | å¯¹è´¦å‰ | ä¸å½±å“å¯¹è´¦æµç¨‹ï¼Œç”¨æˆ·å¯è·³è¿‡ |
| å¼¹çª—æ“ä½œ | é˜»å¡å¼ | ç¡®ä¿ç”¨æˆ·æ³¨æ„åˆ°æé†’ |
| æ·»åŠ æ–¹å¼ | å¼¹çª—å†… | å‡å°‘é¡µé¢è·³è½¬ï¼Œä½“éªŒæ›´æµç•… |
| æ•°æ®æ¨¡å‹ | å¤ç”¨ç°æœ‰è¡¨ | æ— éœ€è¿ç§»ï¼Œå‘åå…¼å®¹ |

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ
