## Context

当前 AI 对账助手是一个基于 Electron + React + TypeScript 构建的桌面应用。应用采用主进程/渲染进程架构，通过 IPC 通道通信。核心功能包括：
- **配置管理**：`electron-store` 存储 3 个独立的文件夹路径（银行流水、发票、归档）
- **文件操作**：`folderService.ts` 处理文件夹选择和扫描，`archiveService.ts` 处理归档移动
- **报告生成**：`reportService.ts` 使用 `xlsx` 库生成 Excel 报告，存储在应用内部导出目录
- **对账流程**：`reconciliationService.ts` 编排规则匹配 → AI 匹配 → 异常检测的完整流程

**当前痛点**：
1. 用户需要在 FolderConfigModal 中分别选择 3 个文件夹（银行、发票、归档），操作繁琐
2. 报告存储在应用内部目录，用户不易找到
3. 首页功能过于复杂，包含多个不常用的模块
4. 对账管理页面混合展示不同状态的批次，缺乏专注性
5. 对账详情页匹配统计维度过多，不直观

## Goals / Non-Goals

**Goals:**
- 简化用户首次使用体验：只需选择一个根文件夹即可自动建立完整目录结构
- 精简首页、对账管理、对账详情三个页面的冗余元素
- 标准化归档体系：以「日期+次序」命名，自动分类存放文件和报告
- 规范化报告系统：3 种标准化 Excel 报告模板，统一命名，自动保存到归档目录
- 对账详情页提供直观的报告下载体验

**Non-Goals:**
- 不改变核心对账算法（规则匹配、AI 匹配、异常检测流程不变）
- 不改变数据库 schema（批次、匹配结果、异常等表结构保持不变）
- 不引入新的 UI 框架或组件库
- 不做多语言支持变更
- 不处理云端同步/多设备协同

## Decisions

### D1: 文件夹配置模型 — 单根目录 + 自动子目录

**选择**：配置存储从 3 个独立路径 (`bankStatementFolder`, `invoiceFolder`, `archiveFolder`) 改为 1 个根路径 (`workspaceFolder`)，子目录路径在运行时通过 `path.join` 动态计算。

**替代方案**：
- (A) 保留 3 个字段，自动填充 — 增加不必要的冗余，且用户可能手动修改某个子路径导致不一致
- (B) 存储根路径 + 3 个子路径 — 过度设计，简单场景下无需这种灵活性

**理由**：子目录名称是固定的（`00归档`、`01发票`、`02银行流水`），不需要独立配置。仅存储根路径，子路径通过常量拼接，保证目录结构的一致性。

**迁移**：对已有配置，取 `bankStatementFolder` 的父目录作为 `workspaceFolder`，若不符合新结构则要求用户重新选择。

### D2: 归档子文件夹命名 — `YYYYMMDD-N` 格式

**选择**：归档文件夹命名格式为 `YYYYMMDD-N`，其中 N 是当天的递增序号。

**实现**：在创建归档目录时，扫描 `00归档` 目录下已有的以当天日期开头的文件夹，取最大序号 + 1。

**替代方案**：
- (A) 使用时间戳 `YYYYMMDD-HHmmss` — 序号更直观易读，且符合用户需求描述
- (B) 使用批次名/UUID — 不便用户在文件管理器中查看

### D3: 报告生成时机 — 对账完成后自动生成

**选择**：对账流程（`executeReconciliation`）完成后，自动调用报告生成并保存到归档目录。同时在对账详情页保留「下载报告」按钮用于手动再次下载。

**实现**：
1. 对账完成（`stage === 'completed' || stage === 'unbalanced'`）后，在 `reconciliationService.ts` 的完成回调中调用 `generateReports`
2. 报告直接写入 `00归档/{YYYYMMDD-N}/AI比对报告/` 目录
3. 报告命名：`{YYYYMMDD-N}{报告类型名}.xlsx`，如 `20260213-3自动入账凭证报告.xlsx`
4. 前端详情页从数据库查询报告记录，展示文件名 + 下载按钮

**替代方案**：
- (A) 仅手动点击按钮生成 — 用户可能忘记生成，且归档内缺少报告
- (B) 报告单独存储在应用目录后再复制一份到归档 — 增加文件管理复杂度

### D4: 报告 Excel 模板字段定义

**选择**：严格按照用户提供的 3 份 Excel 模板定义字段：

**表1 — 自动入账凭证报告**（完全匹配成功的数据）：
```
合并表头行1: 序号 | 交易日期 | 银行流水信息(资金流) [跨2列] | 关联单据信息(业务流) [跨2列] | 核销结果(AI产出) [跨2列] |
合并表头行2:      |          | 对方户名/摘要 | 到账金额     | 客户名称/单据号 | 应收金额     | 核销金额 | 差额     |
```

**表2 — 可解释性报告**（存在需要解释差异的匹配数据）：
```
关联序号 | AI匹配逻辑(Reasoning Chain) | 证据链(Evidence) | 置信度 | 状态
```

**表3 — 异常情况处理报告**（异常数据）：
```
风险等级 | 异常类型 | 银行流水详情 | AI诊断分析 | AI建议操作
```

**实现**：修改现有 `reportService.ts` 中的 `generateAutoEntryReport`、`generateExplainableReport`、`generateExceptionReport` 函数，更新其 Excel 列定义和数据填充逻辑以匹配新模板。

### D5: 对账详情页统计数据重构

**选择**：将原有的 4 种匹配类型（完美匹配、容差匹配、代付匹配、AI 匹配）合并展示为 3 个核心指标：

1. **完美匹配 XX** = `perfectCount + toleranceCount + proxyCount + aiCount`（所有成功匹配的总数）
2. **其中可解释性 XX** = `toleranceCount + proxyCount + aiCount`（需要额外解释的匹配，即完美匹配中的容差匹配、代付匹配的部分）
3. **异常情况 XX** = `exceptions.length`（异常条目数量）

**理由**：原始的 4 维统计对普通用户不够直观。新的 3 维划分更贴近业务语义：成功了多少、哪些需要解释、哪些有问题。

**兼容性**：后端 `MatchingStats` 接口保持不变，仅在前端展示层做聚合计算。

### D6: 首页「已完成任务」模块展示逻辑

**选择**：过滤条件从 `b.status !== 'completed'` 改为 `b.status === 'completed'`，展示已完成的对账批次。移除状态标签和相关颜色逻辑。

### D7: 异常检测结果表格字段

**选择**：对账详情页的异常检测结果表格字段与异常情况处理报告（表3）保持一致：

| 列名 | 数据源 |
|------|--------|
| 风险等级 | `exception.severity` → 高危🔴/中危🟠/低危🟡 |
| 异常类型 | `exception.type` → 有水无票/有票无水/重复支付/金额不符/可疑代付 |
| 银行流水详情 | `exception.detail.bankInfo` 或组合构建 |
| AI诊断分析 | `exception.description` |
| AI建议操作 | `exception.suggestion` |

### D8: 对账流程中文件自动转存

**选择**：对账完成 + 报告生成后，自动将 `01发票` 和 `02银行流水` 中的源文件 **移动**（而非复制）到 `00归档/{YYYYMMDD-N}/` 对应的子文件夹。

**理由**：
- 移动而非复制可以避免磁盘空间翻倍以及避免混淆
- 移动后 `01发票` 和 `02银行流水` 目录清空，用户存入新数据即可进行下一次对账
- 与当前 `archiveService.ts` 的 `moveFiles` 逻辑一致

### D9: FolderConfigModal 组件重构

**选择**：简化为只有一个「选择工作目录」的入口，选择后：
1. 调用新 IPC `electron.folder.initStructure(rootPath)` 在根目录下创建 `00归档`、`01发票`、`02银行流水` 三个子文件夹（如已存在则跳过）
2. 将 `rootPath` 保存到配置的 `workspaceFolder` 字段

**替代方案**：
- 在渲染进程中计算子路径 — 违反 Electron 架构原则，文件系统操作应在主进程
- 保留 3 个文件夹选择 — 不符合需求，用户只需选择一次

## Risks / Trade-offs

**[迁移风险] 旧配置不兼容** → 首次启动检测到旧配置格式时，弹窗提示用户重新选择工作目录，旧配置字段在新版本中被忽略。

**[数据风险] 文件移动失败** → 移动操作使用 try-catch 包裹每个文件，失败时记录日志但不中断整体流程，未移动的文件保留在原位。

**[命名冲突] 同一天多次对账序号计算** → 使用目录名解析而非数据库计数，确保即使数据库记录丢失也能正确递增。

**[报告为空] 对账结果无匹配数据** → 当某种类型的报告没有数据时，不生成对应的 Excel 文件，前端只展示已生成的报告。

**[文件夹不存在] 用户手动删除了工作目录** → 每次对账前检查工作目录及子目录是否存在，不存在则自动重建，并提示用户已经自动重建文件，需上传对应的数据，如银行流水和发票。
