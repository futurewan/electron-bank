## ADDED Requirements

### Requirement: 对账完成后自动生成 Excel 报告
对账流程完成后，系统 SHALL 自动生成最多 3 种 Excel (.xlsx) 格式报告，并保存到 `00归档/{YYYYMMDD-N}/AI比对报告/` 目录中。报告种类根据对账结果的数据决定：
- 有完全匹配成功的数据 → 生成**自动入账凭证报告**
- 匹配成功的数据中存在可解释性数据（容差匹配、代付匹配、AI匹配） → 生成**可解释性报告**
- 存在异常数据 → 生成**异常情况处理报告**

如果某种类型没有对应数据，SHALL 不生成该报告。

#### Scenario: 全部三种报告都有数据
- **WHEN** 对账完成，结果包含完美匹配、可解释性匹配和异常数据
- **THEN** 系统自动生成 3 个 Excel 文件到 `00归档/{YYYYMMDD-N}/AI比对报告/` 目录

#### Scenario: 仅有完美匹配无异常
- **WHEN** 对账完成，所有数据全部完美匹配，无可解释性数据，无异常
- **THEN** 系统仅生成自动入账凭证报告（1 个文件）
- **THEN** 不生成可解释性报告和异常情况处理报告

#### Scenario: 无任何匹配数据
- **WHEN** 对账完成，但没有任何匹配成功的数据
- **THEN** 系统不生成自动入账凭证报告和可解释性报告
- **THEN** 如有异常数据则生成异常情况处理报告

### Requirement: 自动入账凭证报告字段格式
自动入账凭证报告 SHALL 使用以下 Excel 表头结构（双行合并表头）：

**第一行（合并表头）**：

| 序号 | 交易日期 | 银行流水信息(资金流) | _(合并)_ | 关联单据信息(业务流) | _(合并)_ | 核销结果(AI产出) | _(合并)_ |
|------|----------|---------------------|----------|---------------------|----------|-----------------|----------|

**第二行（明细表头）**：

| | | 对方户名/摘要 | 到账金额 | 客户名称/单据号 | 应收金额 | 核销金额 | 差额 |
|--|--|-------------|---------|---------------|---------|---------|------|

其中：
- "银行流水信息(资金流)" 跨 2 列合并（对方户名/摘要、到账金额）
- "关联单据信息(业务流)" 跨 2 列合并（客户名称/单据号、应收金额）
- "核销结果(AI产出)" 跨 2 列合并（核销金额、差额）

数据来源：`matchType` 为 `perfect`、`tolerance`、`proxy`、`ai` 的所有匹配成功记录。

#### Scenario: 生成包含合并表头的 Excel
- **WHEN** 系统生成自动入账凭证报告
- **THEN** Excel 第 1 行包含合并单元格的分类表头
- **THEN** Excel 第 2 行包含明细字段名
- **THEN** 数据从第 3 行开始填充

### Requirement: 可解释性报告字段格式
可解释性报告 SHALL 使用以下 Excel 字段（单行表头）：

| 关联序号 | AI匹配逻辑(Reasoning Chain) | 证据链(Evidence) | 置信度 | 状态 |
|---------|---------------------------|-----------------|--------|------|

字段说明：
- **关联序号**：与自动入账凭证报告中对应记录的序号关联
- **AI匹配逻辑(Reasoning Chain)**：AI 的匹配推理过程说明
- **证据链(Evidence)**：支撑匹配结论的证据信息
- **置信度**：匹配置信度，以百分比格式显示（如 95.00%）
- **状态**：匹配确认状态（如 ✅ 通过）

数据来源：`matchType` 为 `tolerance`、`proxy`、`ai` 的匹配记录。

#### Scenario: 可解释性报告关联自动入账凭证报告
- **WHEN** 可解释性报告中第 1 条的关联序号为 3
- **THEN** 该条数据对应自动入账凭证报告中序号为 3 的记录

### Requirement: 异常情况处理报告字段格式
异常情况处理报告 SHALL 使用以下 Excel 字段（单行表头）：

| 风险等级 | 异常类型 | 银行流水详情 | AI诊断分析 | AI建议操作 |
|---------|---------|------------|----------|----------|

字段说明：
- **风险等级**：使用 emoji+文字 标注，🔴 高危、🟠 中危、🟡 低危
- **异常类型**：有水无票、有票无水、重复支付、金额不符、可疑代付等
- **银行流水详情**：相关银行流水的摘要信息
- **AI诊断分析**：AI 对该异常的分析说明
- **AI建议操作**：AI 建议的处理方案

数据来源：异常检测结果表中的异常记录。

#### Scenario: 高危异常记录
- **WHEN** 存在一条 severity 为 high 的异常
- **THEN** 报告中该行的风险等级列展示为 "🔴 高危"

### Requirement: 报告命名规则
所有报告 SHALL 按照 `{YYYYMMDD}-{N}{报告类型名}.xlsx` 格式命名，其中：
- `YYYYMMDD` 是生成日期
- `N` 是当天的对账次序（与归档文件夹序号一致）
- 报告类型名为：`自动入账凭证报告`、`可解释性报告`、`异常情况处理报告`

#### Scenario: 2026年2月13日第3次对账的报告命名
- **WHEN** 2026年2月13日第3次对账完成并生成报告
- **THEN** 自动入账凭证报告文件名为 `20260213-3自动入账凭证报告.xlsx`
- **THEN** 可解释性报告文件名为 `20260213-3可解释性报告.xlsx`
- **THEN** 异常情况处理报告文件名为 `20260213-3异常情况处理报告.xlsx`

### Requirement: 对账详情页展示报告列表并支持下载
对账详情页 SHALL 展示本次对账自动生成的报告文件名列表，每个报告名称旁配有「下载」按钮。

#### Scenario: 展示已生成的报告
- **WHEN** 对账完成且生成了 2 份报告（自动入账凭证报告、异常情况处理报告）
- **THEN** 页面展示这 2 份报告的文件名
- **THEN** 每份报告旁显示「下载」按钮

#### Scenario: 点击下载按钮
- **WHEN** 用户点击某份报告的「下载」按钮
- **THEN** 系统打开该报告文件所在的文件夹（在系统文件管理器中定位到文件）

#### Scenario: 无报告生成
- **WHEN** 对账完成但没有匹配结果（无数据）
- **THEN** 页面不展示报告列表区域

### Requirement: 对账详情页异常检测结果表格
对账详情页 SHALL 以表格形式展示异常检测结果，表格字段与异常情况处理报告一致：

| 风险等级 | 异常类型 | 银行流水详情 | AI诊断分析 | AI建议操作 |

#### Scenario: 有异常数据时展示表格
- **WHEN** 对账完成且检测到异常数据
- **THEN** 页面展示异常检测结果表格
- **THEN** 表格列为：风险等级、异常类型、银行流水详情、AI诊断分析、AI建议操作
- **THEN** 风险等级使用 emoji 标注（🔴 高危、🟠 中危、🟡 低危）

#### Scenario: 无异常数据
- **WHEN** 对账完成且未检测到任何异常
- **THEN** 页面展示"未发现异常"提示

### Requirement: 对账详情页匹配统计简化为三项
对账详情页的匹配统计模块 SHALL 简化为以下 3 项指标：
1. **完美匹配** = `perfectCount + toleranceCount + proxyCount + aiCount`
2. **其中可解释性** = `toleranceCount + proxyCount + aiCount`
3. **异常情况** = 异常检测结果条目数

同时 SHALL 保留剩余银行流水和剩余发票的统计展示。

#### Scenario: 统计数据展示
- **WHEN** 对账完成，perfectCount=50, toleranceCount=5, proxyCount=3, aiCount=2, 异常=4
- **THEN** 页面展示：完美匹配 60，其中可解释性 10，异常情况 4
- **THEN** 页面展示：剩余银行流水 X / 总数 Y，剩余发票 X / 总数 Y

### Requirement: 移除对账详情页批次信息卡片
对账详情页 SHALL 移除右侧的「批次信息」卡片（包含批次ID、创建时间、银行流水数、发票数）。

#### Scenario: 批次信息不可见
- **WHEN** 用户打开对账详情页
- **THEN** 页面不展示批次ID、创建时间等批次元信息卡片
