# 设计：AI 匹配增强

## 上下文
当前的对账系统受到两个主要因素的限制：
1. **PDF 解析脆弱性**：基于正则表达式的解析器在处理非标准发票格式时容易失败（如 `0` 金额或 `未知` 销售方）。
2. **死板的匹配逻辑**：规则系统无法理解语义关系（如“滴滴”与“运输服务”的发票关联）或模糊的金额/日期差异。

本设计引入了两阶段的 AI 干预策略，利用 LLM 进行数据恢复和语义推理。

## 目标 / 非目标
**目标：**
* **恢复“僵尸”发票**：重新处理解析失败的发票原始文本，让 AI 提取正确的金额和销售方。
* **语义匹配**：通过上下文理解来匹配流水和发票，解决严格规则无法覆盖的情况。
* **无缝集成**：将新流程插入现有的 `reconciliationService` 中，不破坏原有规则。
* **透明性**：在数据库中清晰标记由 AI 修改或匹配的数据（`parse_source` 和 `match_type`）。

**非目标：**
* 完全替代正则解析器（仍作为主要的快速手段）。
* 实时处理（这是批处理任务）。
* 处理纯图片 PDF（OCR 超出本次范围，虽然 LLM 可能辅助提取）。

## 决策

### 1. 两阶段架构
我们将 AI 干预分为两个独立阶段：
* **阶段 1：修复（匹配前）**
    - **重点**：数据质量。
    - **输入**：`amount=0` 或 `sellerName="未知销售方"` 的发票。
    - **动作**：读取 PDF -> LLM 提取 -> 更新数据库。
    - **理由**：在匹配前修复数据，能最大化后续规则匹配的成功率。
* **阶段 2：匹配（语义）**
    - **重点**：关系发现。
    - **输入**：未匹配的流水和发票。
    - **动作**：构建上下文 Prompt -> LLM 决策 -> 创建匹配记录。

### 2. “修复优先”执行流
在 `executeAIMatching` 中，我们将在**匹配**阶段之前运行**修复**阶段。
* *原因*：修复发票可能使其变得可匹配。
* *实现*：在 AI 服务例程开始时调用新函数 `repairBrokenInvoices`。

### 3. Prompt 工程与模型选择
* **模型推荐**：明确支持并推荐 **DeepSeek V3**（速度/成本优势）和 **DeepSeek R1**（复杂推理）。
* **修复 Prompt**：提供 PDF 前 3000 字符。指示 AI 返回严格的 JSON 对象（含 `amount`, `date`, `sellerName`）。
* **匹配 Prompt**：提供流水摘要和“候选”发票列表（±10% 金额筛选）。要求 AI 选择最佳索引或返回 null。

### 4. 数据库 Schema 更新
* 无需新增表。
* **Invoices 表**：利用 `parseSource` 列标记 `'ai_repair'`。
* **Match Results 表**：使用 `matchType='ai'` 和 `reason` 字段存储 AI 解释。

## 风险 / 权衡

### 成本 vs 价值
* **风险**：发送完整的 PDF 文本消耗 Token。
* **缓解**：仅修复“损坏”的发票（金额=0）。跳过有效发票，严格限制成本。

### 幻觉
* **风险**：AI 可能编造金额或日期。
* **缓解**：
    - 强制 JSON 格式。
    - 保存前验证 `amount > 0`。
    - 标记 AI 匹配为 `needsConfirmation=true`（建议 UI 显示确认）。

### 性能
* **风险**：串行 LLM 调用较慢。
* **缓解**：异步处理。实现批处理或串行处理并提供进度更新，保持 UI 响应。
