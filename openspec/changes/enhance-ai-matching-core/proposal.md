# 提案：AI 匹配增强

## 目标

通过引入 AI 能力来解决 PDF 解析失败问题，并通过语义分析提高对账的匹配准确率。

## 背景

### 问题陈述
当前的基于规则的对账系统（精确金额/名称匹配）面临以下挑战：
1. **PDF 解析失败 ("僵尸发票")**：
   - 传统的基于正则表达式的解析方式非常死板，在处理复杂或非标版式时容易失败。
   - 结果：生成了 `amount=0` 或 `sellerName="未知销售方"` 的无效发票记录，这些记录永远无法被匹配。
2. **语义鸿沟**：
   - 银行摘要通常使用非正式语言（如“报销餐费”）与发票上的正式内容（“餐饮服务”）不一致。
   - 规则系统无法理解这种显而易见的人类可读关联。
3. **模糊差异**：
   - 日期偏差（发票后几天的付款）和微小的金额差异（银行手续费、税额舍入）很难用严格的逻辑代码来处理。

### 解决方案
我们引入一种两阶段的 AI 干预策略：

1. **阶段 1：AI 修复（匹配前）**
   - **对象**： "损坏"的发票（状态=pending 且 (金额=0 或 销售方=未知)）。
   - **动作**：重新读取原始 PDF 文本，使用 LLM 提取结构化字段（金额、销售方、日期、代码、号码）。
   - **结果**： "复活"失败的发票，使其能进入正常的匹配流程。

2. **阶段 2：语义匹配（匹配中）**
   - **对象**：剩余的未匹配流水和发票。
   - **动作**：使用 LLM 分析流水的*上下文*（摘要、日期、金额）与候选发票的关系。
   - **逻辑**：
     - 允许模糊金额匹配（例如：10% 容差内）。
     - 理解语义关系（例如："车票" <-> "运输服务"）。
     - 验证日期临近性。
   - **结果**：提高召回率的高置信度语义匹配。

## 变更内容

### 新组件
- **AI 修复服务**：当正则解析失败时，用于从原始 PDF 文本中提取结构化数据的工具。
- **AI 匹配引擎**：增强的匹配服务，构建包含流水上下文和候选发票的 Prompt 供 LLM 分析。

### 工作流更新
- **对账流水线**：在主匹配循环*之前*插入 `repairBrokenInvoices` 步骤，确保最大的数据可用性。
- **数据模型**：无重大 Schema 变更，但引入 `parseSource='ai_repair'` 来追踪数据来源。

## 能力

### 新增能力
- `ai-pdf-repair`: 具备对解析失败的 PDF 发票进行 AI 回退提取的能力。
- `semantic-matching`: 具备基于摘要和上下文语义理解来匹配财务记录的能力。

### 修改的能力
- `reconciliation-workflow`: 更新执行流程以包含修复阶段。
- `pdf-invoice-parse`: 扩展解析逻辑以包含基于 AI 的恢复机制。

## 影响

1. **更高的成功率**：显著减少因解析错误导致的“未匹配”记录数量。
2. **减少人工工作**：自动修正以前用户必须手动处理的失败发票。
3. **成本**：引入了 LLM Token 消耗，但通过仅针对损坏/未匹配记录进行优化，控制了成本。
