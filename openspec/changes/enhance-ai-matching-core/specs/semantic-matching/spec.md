# 规格：语义匹配

## 目标
利用 LLM 的上下文语义理解能力，针对基于规则（精确/模糊）匹配失败的流水和发票，实现高置信度的逻辑匹配。

## 范围
- **输入**：对账周期内剩余的未匹配流水及未匹配发票。
- **处理**：调用 LLM 分析流水摘要、日期、金额与候选发票的语义关系。
- **输出**：创建新的匹配关系（类型 `ai`），或保持未匹配状态。

## 匹配逻辑

### 预筛选（Rule Filtering）
在提交给 LLM 之前，系统 SHALL 基于以下规则筛选候选发票集合：
1. **日期范围**：发票日期在流水日期前后 30 天内（Configurable）。
2. **金额范围**：发票金额在流水金额的 ±10% 范围内（或者 ±5 元绝对值）。
   - 注：允许模糊金额匹配以处理税差、手续费等。

若某条流水无任何符合上述条件的发票，直接跳过 AI 匹配。

### LLM 输入 (Context Construction)
对于每条待匹配流水，构建以下 Context：
1. **流水详情**：
   - 日期：`YYYY-MM-DD`
   - 摘要/备注：`summary` + `remark`
   - 金额（出账）：`amount`
   - 收款方（如有）：`counterparty`

2. **候选发票列表（Top N）**：
   - 索引：`index` (0, 1, 2...)
   - 发票详情：
     - 日期：`invoiceDate`
     - 销售方：`sellerName`
     - 项目名：`itemName`
     - 价税合计：`totalAmount`

3. **任务指令**：
   - 分析流水摘要与发票项目的语义关联（如 "滴滴" <-> "客运服务", "美团" <-> "餐饮"）。
   - 分析金额合理性（是否相近）。
   - 分析日期合理性（发票是否早于或接近报销日）。
   - 返回最匹配的发票索引，或 `null`。

### LLM 输出结构
期望的 JSON 结构：
```json
{
  "matchIndex": 0, // 或 null
  "reason": "流水摘要 '打车' 与发票项目 '客运服务' 语义相符，且金额完全一致。",
  "confidence": "high" // high, medium, low
}
```

## 结果处理

### 匹配确认
1. **验证**：检查返回的 `matchIndex` 是否在候选范围内。
2. **创建记录**：
   - 在 `match_results` 表中创建记录。
   - `matchType` = `'ai'`。
   - `desc` = LLM 返回的 `reason`。
   - `status` = 基于 `confidence` 决定（high -> `confirmed`，medium/low -> `pending_review`）。建议默认 `pending_review` 需人工确认。

### 状态更新
- 匹配成功后，对应的流水和发票状态需更为 `matched`（或 `proposed`）。

## 交互设计
- **AI 匹配结果展示**：在前端对账界面，AI 匹配的结果应带有特殊标记（如 ✨ 图标）。
- **人工复核**：用户必须能看到 AI 的推荐理由，并一键确认或拒绝。

## 性能与限制
- **批处理**：建议按 10-20 条流水为一组进行批处理，或每条流水独立请求（取决于模型上下文窗口）。
- **成本控制**：仅针对规则匹配失败的剩余记录运行。
